name: Truy Cáº­p Tá»« Xa Windows Server 2022

on:
  # KÃ­ch hoáº¡t thá»§ cÃ´ng tá»« giao diá»‡n GitHub Actions
  workflow_dispatch:

jobs:
  secure-rdp:
    # 1. DÃ¹ng Windows Server 2022 Runner
    runs-on: windows-2022
    # Äáº·t thá»i gian timeout tá»‘i Ä‘a 6 giá» (3600 phÃºt)
    timeout-minutes: 3600

    steps:
      - name: âš™ï¸ Cáº¥u HÃ¬nh RDP vÃ  TÆ°á»ng Lá»­a Windows
        run: |
          Write-Host "KÃ­ch hoáº¡t Remote Desktop vÃ  má»Ÿ cá»•ng TÆ°á»ng Lá»­a..."
          # Báº­t Remote Desktop báº±ng cÃ¡ch Ä‘áº·t fDenyTSConnections = 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          
          # XÃ³a luáº­t cÅ© náº¿u tá»“n táº¡i
          netsh advfirewall firewall delete rule name="RDP-Inbound"
          
          # Má»Ÿ cá»•ng RDP (3389) qua TÆ°á»ng Lá»­a (Firewall)
          netsh advfirewall firewall add rule name="RDP-Inbound" `
            dir=in action=allow protocol=TCP localport=3389
          
          Write-Host "Cáº¥u hÃ¬nh RDP hoÃ n táº¥t."

      - name: ğŸ” Táº¡o NgÆ°á»i DÃ¹ng Admin123 vÃ  Máº­t Kháº©u Báº£o Máº­t
        run: |
          $RDP_USER = "Admin123"
          Write-Host "Báº¯t Ä‘áº§u táº¡o ngÆ°á»i dÃ¹ng $RDP_USER..."
          
          # Táº¡o máº­t kháº©u ngáº«u nhiÃªn vÃ  báº£o máº­t (Ã­t nháº¥t 16 kÃ½ tá»±)
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # KÃ½ tá»± Ä‘áº·c biá»‡t
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random -Count 16 })
          
          # Táº¡o SecureString tá»« máº­t kháº©u
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Táº¡o ngÆ°á»i dÃ¹ng Admin123, Ä‘áº·t máº­t kháº©u vÃ  khÃ´ng bao giá» háº¿t háº¡n
          New-LocalUser -Name $RDP_USER -Password $securePass -AccountNeverExpires
          
          # ThÃªm ngÆ°á»i dÃ¹ng vÃ o nhÃ³m Administrators (YÃªu cáº§u cá»§a báº¡n)
          Add-LocalGroupMember -Group "Administrators" -Member $RDP_USER
          
          # ThÃªm ngÆ°á»i dÃ¹ng vÃ o nhÃ³m Remote Desktop Users
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $RDP_USER
          
          # LÆ°u thÃ´ng tin vÃ o biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ hiá»ƒn thá»‹ sau
          echo "RDP_USER=$RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "Táº¡o ngÆ°á»i dÃ¹ng vÃ  Ä‘áº·t máº­t kháº©u báº£o máº­t hoÃ n táº¥t."

      - name: â¬‡ï¸ CÃ i Äáº·t Tailscale
        run: |
          Write-Host "Táº£i vÃ  cÃ i Ä‘áº·t Tailscale Ä‘á»ƒ táº¡o káº¿t ná»‘i báº£o máº­t..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-x64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Write-Host "CÃ i Ä‘áº·t Tailscale hoÃ n táº¥t."

      - name: ğŸ”— Thiáº¿t Láº­p Káº¿t Ná»‘i Tailscale
        run: |
          Write-Host "Káº¿t ná»‘i vá»›i Tailnet cá»§a báº¡n..."
          # Sá»­ dá»¥ng Auth Key Ä‘á»ƒ kÃ­ch hoáº¡t Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win2022-gh-runner-$env:GITHUB_RUN_ID --ssh
          
          # Äá»£i Tailscale gÃ¡n IP
          $tsIP = $null
          $retries = 0
          Write-Host "Äang chá» Tailscale gÃ¡n Ä‘á»‹a chá»‰ IP..."
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Lá»—i: Tailscale khÃ´ng gÃ¡n Ä‘Æ°á»£c Ä‘á»‹a chá»‰ IP. Vui lÃ²ng kiá»ƒm tra Auth Key."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "ÄÃ£ gÃ¡n IP thÃ nh cÃ´ng: $tsIP"
      
      - name: ğŸ›‘ Duy TrÃ¬ Káº¿t Ná»‘i vÃ  Hiá»ƒn Thá»‹ ThÃ´ng Tin Truy Cáº­p
        run: |
          Write-Host "`n=== THÃ”NG TIN TRUY Cáº¬P RDP ==="
          Write-Host "Há»‡ Äiá»u HÃ nh: Windows Server 2022"
          Write-Host "Äá»‹a Chá»‰ (Tailscale IP): $env:TAILSCALE_IP"
          Write-Host "TÃªn NgÆ°á»i DÃ¹ng: $env:RDP_USER"
          Write-Host "Máº­t Kháº©u (Báº£o máº­t): $env:RDP_PASSWORD"
          Write-Host "============================`n"
          
          Write-Host "BÃ¢y giá» báº¡n cÃ³ thá»ƒ dÃ¹ng RDP Client Ä‘á»ƒ káº¿t ná»‘i qua IP trÃªn."
          
          # VÃ²ng láº·p vÃ´ háº¡n Ä‘á»ƒ giá»¯ cho Runner hoáº¡t Ä‘á»™ng
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Ä‘ang hoáº¡t Ä‘á»™ng - Vui lÃ²ng dÃ¹ng Ctrl+C trong workflow Ä‘á»ƒ káº¿t thÃºc."
              Start-Sleep -Seconds 300
          }
